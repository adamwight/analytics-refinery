<?xml version="1.0" encoding="UTF-8"?>
<coordinator-app xmlns="uri:oozie:coordinator:0.4"
    name="webrequest-monitor_done_flag-${webrequest_source}-coord"
    frequency="${coord:hours(1)}"
    start="${start_time}"
    end="${stop_time}"
    timezone="Universal">

    <parameters>
        <property>
            <name>queue_name</name>
            <value>adhoc</value>
        </property>

        <!-- Required properties. -->
        <property><name>name_node</name></property>
        <property><name>job_tracker</name></property>
        <property><name>workflow_file</name></property>
        <property><name>start_time</name></property>
        <property><name>stop_time</name></property>
        <property><name>data_directory</name></property>

        <property><name>webrequest_source</name></property>
    </parameters>

    <controls>
        <!--
        There is not much sense in having more than one of the
        workflows running. That could only hide issues.  So we limit
        to one.
        -->
        <concurrency>1</concurrency>


        <!--
        Backfilling gets in the way anyways, so we can throttle as
        well to 1, to not artifically keep jobs waiting.
        -->
        <throttle>1</throttle>
    </controls>

    <datasets>
        <!--
        Include the given datasets_file file.  This should
        define the "webrequest" dataset for this coordinator.
        -->
        <include>${datasets_file}</include>
    </datasets>

    <input-events>
        <data-in name="input" dataset="webrequest">
            <instance>${coord:current(0)}</instance>
        </data-in>
    </input-events>

    <action>
        <workflow>
            <app-path>${workflow_file}</app-path>
            <configuration>

                <!-- Pass these properties through to the workflow -->
                <property><name>name_node</name><value>${name_node}</value></property>
                <property><name>job_tracker</name><value>${job_tracker}</value></property>
                <property><name>queue_name</name><value>${queue_name}</value></property>
                <property><name>icinga_service_description</name><value>hive_partition_webrequest-${webrequest_source}</value></property>
                <property><name>location</name><value>${coord:dataIn('input')}</value></property>
            </configuration>
        </workflow>
    </action>
</coordinator-app>

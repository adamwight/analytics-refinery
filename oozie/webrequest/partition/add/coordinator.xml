<coordinator-app xmlns="uri:oozie:coordinator:0.4"
    name="hive_add_partition-${table}_${webrequest_source}-coord"
    frequency="${coord:hours(1)}"
    start="${start_time}"
    end="${stop_time}"
    timezone="Universal">

    <parameters>
        <property>
            <name>queue_name</name>
            <value>standard</value>
        </property>

        <!-- Required properties. -->
        <property><name>name_node</name></property>
        <property><name>job_tracker</name></property>
        <property><name>workflow_file</name></property>
        <property><name>start_time</name></property>
        <property><name>stop_time</name></property>
        <property><name>data_directory</name></property>

        <property><name>hive_site_xml</name></property>
        <property><name>database</name></property>
        <property><name>table</name></property>
        <property><name>webrequest_source</name></property>
    </parameters>

    <controls>
        <!--
        Altering hive partitions is cheap.  If there is an
        occasion where we have to add a bunch all at once,
        do it!
        -->
        <concurrency>168</concurrency>
    </controls>

    <datasets>
        <!--
        Include the given datasets_file file.  This should
        define the "webrequest" dataset for this coordinator.
        -->
        <include>${datasets_file}</include>
    </datasets>

    <input-events>
        <data-in name="input" dataset="webrequest">
            <instance>${coord:current(0)}</instance>
        </data-in>
        <!--
        Having a data-in defined for current(1) will
        keep the workflow from running until the next
        hour's directory is created.
         -->
        <data-in name="ready_indicator" dataset="webrequest">
            <instance>${coord:current(1)}</instance>
        </data-in>
    </input-events>

    <action>
        <workflow>
            <app-path>${workflow_file}</app-path>
            <configuration>

                <!-- Pass these properties through to the workflow -->
                <property><name>name_node</name><value>${name_node}</value></property>
                <property><name>job_tracker</name><value>${job_tracker}</value></property>
                <property><name>queue_name</name><value>${queue_name}</value></property>

                <property>
                    <name>hive_site_xml</name>
                    <value>${hive_site_xml}</value>
                </property>
                <property>
                    <name>database</name>
                    <value>${database}</value>
                </property>
                <property>
                    <name>table</name>
                    <value>${table}</value>
                </property>
                <property>
                    <name>partition_spec</name>
                    <value>webrequest_source='${webrequest_source}',${coord:formatTime(coord:nominalTime(), "'year='y,'month='M,'day='d,'hour='H")}</value>
                </property>
                <property>
                    <name>location</name>
                    <value>${coord:dataIn('input')}</value>
                </property>

            </configuration>
        </workflow>
    </action>
</coordinator-app>

<?xml version="1.0" encoding="UTF-8"?>
<workflow-app xmlns="uri:oozie:workflow:0.4"
    name="send-error-email-${parent_name}-wf">

    <!--
        This subworflow is a simple wrapper over the oozie email action
          allowing to provide default values for most of the needed fields.
    -->

    <parameters>

        <property>
            <name>parent_name</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>UNSET</value>
            <description>
                The name of the parent workflow in error.
            </description>
        </property>

        <property>
            <name>parent_failed_action</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>UNSET</value>
            <description>
                The name of the parent action that failed.
            </description>
        </property>

        <property>
            <name>to</name>
            <value>otto@wikimedia.org,joal@wikimedia.org,milimetric@wikimedia.org,madhuvishy@wikimedia.org,mforns@wikimedia.org,nuria@wikimedia.org</value>
            <description>
                The comma-separated list of email recipients
            </description>
        </property>

        <property>
            <name>subject</name>
            <value>Fatal Error - Oozie Job ${parent_name}</value>
            <description>
                The subject of the email
            </description>
        </property>

        <property>
            <name>body</name>
            <value>
                The action that raised an error is thought to be ${parent_failed_action}.
                Please have a look and take necessary action !
                Thanks :)
                -- Oozie
            </value>
            <description>
                The body of the email
            </description>
        </property>

    </parameters>

    <start to="send_email"/>

    <action name="send_email">
        <email xmlns="uri:oozie:email-action:0.1">
            <to>${to}</to>
            <subject>${subject}</subject>
            <body>${body}</body>
        </email>
        <ok to="end"/>
        <error to="kill"/>
    </action>

    <kill name="kill">
        <message>send_error_email action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>
    <end name="end"/>
</workflow-app>
